'use strict';

var path = require('path');

var _ = require('lodash');
var colorPath = require('color-path');
var gulp = require('gulp');

var $ = require('../plugins');
var resolveConfigGetters = require('../reduce-args').resolveConfigGetters;

var cache = {};

module.exports = function $initDest(options, dest) {
  if (!dest) {
    dest = options;
    options = {};
  }

  options = _.defaults(options || {}, {log: true});

  return this.$decorate(function $rememberDest(parent, config) {
    var opts = resolveConfigGetters.call(config, options);

    return {
      stream: $.multipipe(
        parent,
        gulp.dest(function(file) {
          var d = dest;
          if (_.isFunction(d))
            d = d.call(config, arguments);

          if (opts.log) {
            $.log('Writing file ' + colorPath.colorize(
                path.resolve(
                  opts.cwd,
                  path.join(d, file.relative)
                )
              ) + 'â€¦');
          }

          _.each(file.history, function(name) {
            cache[name] = cache[name] || {
                $history: file.history,
              };
            cache[name][d] = file.relative;
          });

          return d;
        }, opts),
        $.deleteStream(cache, opts, config),
        $.noop()
      ),
      config: config
    };
  });
};
