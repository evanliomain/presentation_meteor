'use strict';

var _ = require('lodash');
var uuid = require('uuid');

var $ = require('../plugins');

module.exports = function $initRemember(name) {
  if (!name)
    name = uuid.v4();

  return this.$decorate(function $remember(parent, config) {
    var n = name;
    if (_.isFunction(n))
      n = n.call(config);

    _.each(config.$changed || {}, function(event) {
      if (event.type !== 'deleted')
        return;
      $.rememberHistory.forget(n, event.path);
    });

    return {
      stream: $.multipipe(parent, $.rememberHistory(n), $.noop()),
      config: config
    };
  });
};
