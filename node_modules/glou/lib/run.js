'use strict';

var $ = require('./plugins');
var Config = require('./config');
var error = require('./error');

// Run a pipeline
// If `changedEvent`, reconfigure the pipeline to make an incremental build instead of a full build.
module.exports = function run(pipeline, config) {
  // A reemiter is added at the end of the pipeline to emit errors. It is a trick to handle errors in a stream build.
  var reemiter = new error.Reemiter();
  error.GlouError.assert(!config || config instanceof Config, '`config` argument is internal');

  config = config || new Config();
  config.$reemiter = reemiter;

  return $.start()
    .pipe(pipeline.call(config))
    .pipe(reemiter)
  ;
};
