'use strict';

var _ = require('lodash');
var gulp = require('gulp');

var Config = require('./config');
var glou = require('./');

function Task(name, pipeline) {
  this.name = name;
  this.$pipeline = pipeline;
  this.$changed = {};

  var run = this.run.bind(this);
  run.changed = this.changed.bind(this);
  gulp.task(name, run);
}
Task.prototype.run = function run() {
  var changed = this.$changed;
  this.$changed = {};
  return glou.run(this.$pipeline, new Config({$changed: changed}));
};
Task.prototype.changed = function(changed) {
  var size = _.size(this.$changed);
  this.$changed[changed.path] = changed;
  if (size > 1)
    return;
  gulp.start(this.name);
};

module.exports = function(name, pipeline) {
  new module.exports.Task(name, pipeline);
  return this;
};
module.exports.Task = Task;
